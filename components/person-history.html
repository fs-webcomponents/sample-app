<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/fs-client/fs-client.html">
<link rel="import" href="../bower_components/fs-behavior/fs-behavior.html">

<!--
List the 10 most recent persons the user has viewed. It works as a dropdown that
shows the current person and lists previous ones.

The list isn't persistent but it probably should be.

This does _not_ use the
[User History](https://familysearch.org/developers/docs/api/users/User_History_resource)
API because we don't yet have a clear strategy around sending updates to the API.

Basic example:

    <person-history></person-history>

@element person-history
-->
<dom-module id="person-history">
  <template>
    <style>
      paper-dropdown-menu {
        cursor: pointer;
        --paper-input-container-label: {
          color: #fff;
        }
        --paper-input-container-input: {
          color: #fff;
          cursor: pointer;
        }
        --paper-input-container-underline: {
          display: none;
        }
        --paper-dropdown-menu-icon: {
          color: #fff;
        }
      }
    </style>
    <fs-client></fs-client>
    <paper-dropdown-menu id="menu" label="History" no-label-float horizontal-align="left">
      <paper-listbox id="list" slot="dropdown-content">
        <template is="dom-repeat" items="{{persons}}">
          <paper-item label="{{item.display.name}}" on-tap="_selectPerson">
            <paper-item-body two-line>
              <div>{{item.display.name}}</div>
              <div secondary>{{item.id}}</div>
            </paper-item-body>
          </paper-item>
        </template>
      </paper-listbox>
    </paper-card>
  </template>
</dom-module>

<script>

  Polymer({

    is: 'person-history',
    
    properties: {
      
      /**
       * List of people in the history.
       */
      persons: {
        type: Array,
        value: function(){
          return [];
        }
      }
      
    },
    
    behaviors: [FSBehavior],
    
    ready: function(){
      
      // Make sure the first person in the list is always selected. We do this
      // by explicitly selecting the first person whenever the list changes.
      //
      // Due to a bug (https://github.com/PolymerElements/iron-selector/issues/154)
      // we select the 2nd item then select the 1st item. Whenever that bug is
      // fixed then we should only need to select the 1st item.
      var list = this.$.list;
      list.addEventListener('iron-items-changed', function(){
        list.selectIndex(1);
        list.selectIndex(0);
      });
    },
    
    /**
     * Clear the list. Should probably only be used when the user signs out.
     */
    clear: function(){
      this.persons = [];
    },
    
    /**
     * Add a person to the list. This component will load the person specified
     * by the ID so that it can display the person's name.
     * 
     * @param {String} personId ID of the person to be added.
     */
    addPerson: function(personId){
      var self = this,
          index = this._indexOf(personId),
          person;
          
      // When modifying an array that is a Polymer element property which data
      // is bound to we must use the Polymer array mutation methods so that
      // Polymer knows the data changed and can respond accordingly.
      // https://www.polymer-project.org/1.0/docs/devguide/model-data#work-with-arrays
      
      // If the person is already in the history list then move them to the
      // front of the list and mark them as selected.
      if(index >= 0){
        person = this.persons[index];
        this.splice('persons', index, 1);
        this._addPerson(person);
      }
      
      // If the person isn't already in the list then we need to add them.
      else {
        this.getClient().get('/platform/tree/persons/' + personId, function(error, response){
          if(response && response.statusCode === 200){
            self._addPerson(response.data.persons[0]);
          }
        });
      }
    },
    
    /**
     * Helper method that actually adds the person to the list and updates
     * the state.
     * 
     * @param {Person} person
     */
    _addPerson: function(person){
      
      // Add the person to the front of the list.
      this.unshift('persons', person);
      
      // Remove people at the end of the list if it's longer than 10.
      while(this.persons.length > 10){
        this.pop('persons');
      }
    },
    
    /**
     * Get the index of a person in the list. Returns -1 if they aren't in the list.
     * 
     * @param {String} personId
     */
    _indexOf: function(personId){
      for(var i = 0; i < this.persons.length; i++){
        if(this.persons[i].id === personId){
          return i;
        }
      }
      return -1;
    },
    
    _selectPerson: function(event){
      this.fire('person-select', {personId: event.model.item.id});
    }
    
  });

</script>
