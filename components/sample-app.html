<link rel="import" href="../bower_components/polymer/polymer-element.html">
<script src="/bower_components/page/page.js"></script>

<!-- Paper Elements -->
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">

<!-- FamilySearch Components -->
<link rel="import" href="../bower_components/fs-client/fs-client.html">
<link rel="import" href="../bower_components/fs-signin/fs-signin.html">
<link rel="import" href="../bower_components/fs-pedigree/fs-pedigree.html">
<link rel="import" href="../bower_components/fs-person-card/fs-person-card.html">
<link rel="import" href="../bower_components/fs-api-aware/fs-api-aware.html">
<link rel="import" href="../bower_components/fs-add-person/fs-add-person.html">

<!-- Custom Sample App Components -->
<link rel="import" href="person-history.html">
<link rel="import" href="person-details.html">

<dom-module id="sample-app">
  <template>
    <style>
      app-header {
        background-color: var(--google-green-500);
        margin-bottom: 16px;
      }
      
      app-toolbar .title a {
        color: white;
        text-decoration: none;
        cursor: pointer;
        pointer-events: auto;
      }
      
      fs-signin {
        --fs-signin-signin: {
          background-color: var(--google-red-500);
        }
        font-size: initial;
      }
      
      [hidden] {
        display: none !important;
      }
      
      .container {
        max-width: 900px;
        margin: auto;
      }
      
      #main {
        padding-bottom: 32px;
      }
      
      #welcome {
        text-align: center;
      }
      
      #welcome img {
        height: 600px;
        margin: auto;
        margin-top: 64px;
      }
      
      #person-nav-toolbar {
        margin-bottom: 1em;
      }
      
      #loader {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0,0,0,.2);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      paper-spinner-lite {
        --paper-spinner-color: var(--google-green-500);
      }
      
      fs-pedigree {
        --fs-pedigree-person-width: 200px;
      }
      
      fs-person-card {
        display: none;
        position: absolute;
      }
      
      #footer {
        text-align: right;
        margin: 0 16px 16px 0;
      }
      
      #footer a,
      #footer a:visited {
        color: #42A5F5;
        text-decoration: none;
      }
    </style>
    
    <fs-client id="client" 
      app-key="a02j00000099Mc2AAE" 
      redirect-uri="/"
      save-access-token 
      exchange-code 
      authenticated="{{authenticated}}"
      debounce-duplicates></fs-client>
    
    <app-header>
      <app-toolbar>
        <div main-title class="title"><a href="/">Sample App</a></div>
        <person-history id="history" on-person-select="_historySelect"></person-history>
        <fs-signin></fs-signin>
      </app-toolbar>
    </app-header>
    
    <div id="main">
      
      <div class="container">
        
        <!-- content displayed when the user isn't signed in -->
        <div id="welcome" hidden$="[[authenticated]]">
          <h1>FamilySearch Web Components Sample App</h1>
          <fs-signin></fs-signin>
          <div><img src="/public/fs-wc-screenshot.png" /></div>
        </div>
        
        <!-- when the user is signed in, this button helps them toggle between the person details and pedigree -->
        <div id="person-nav-toolbar" hidden$="[[!authenticated]]">
          <paper-button on-tap="_togglePage">[[_navButtonText(page)]]</paper-button>
        </div>
        
        <person-details 
          id="personDetails" 
          person-id="[[personId]]" 
          hidden$="[[!_showPersonDetails(authenticated, page)]]" 
          loading="{{personDetailsLoading}}"
          on-person-tap="_showPersonCard"></person-details>
        <fs-pedigree 
          id="pedigree" 
          person-id="[[personId]]" 
          hidden$="[[!_showPedigree(authenticated, page)]]"
          on-person-tap="_showPersonCard"
          on-add-person="_addPedigreePerson"></fs-pedigree>
      </div>
      
    </div>
    
    <div id="footer">
      <p>
        <a href="https://github.com/fs-webcomponents/sample-app" target="_blank">Source Code on GitHub</a> |
        <a href="https://www.polymer-project.org" target="_blank">Built with Polymer</a>
      </p>
    </div>
    
    <!-- This card is shown when people are clicked on from the family or pedigree section -->
    <fs-person-card id="personCard">
      <div class="card-actions">
        <paper-button on-tap="_navigateToProfile"><iron-icon icon="perm-identity"></iron-icon> Profile</paper-button>
        <paper-button on-tap="_navigateToPedigree"><iron-icon icon="hardware:device-hub"></iron-icon> Pedigree</paper-button>
      </div>
    </fs-person-card>
    
    <!-- This dialog is shown when a person is being added to the tree -->
    <fs-add-person id="addPerson" on-person-added="_reload"></fs-add-person>

    <!-- The loader shows when person details are loading -->
    <div id="loader" hidden$="[[!loading]]">
      <paper-spinner-lite active></paper-spinner>
    </div>
  </template>
  <script>
    class SampleApp extends FSApiAwareMixin(Polymer.Element) {
  
      static get is() { return 'sample-app'; }
      
      static get properties() {
        return {
          /**
           * The personId is set by the routes (the routes extract if from the URL)
           * then it's passed on to the person-history, person-details, and fs-pedigree
           * components.
           */
          personId: {
            type: String,
            observer: '_personIdChanged'
          },
          
          /**
           * True if either the user is loading or the person-details is loading.
           */
          loading: {
            type: Boolean,
            value: false,
            computed: '_isLoading(personLoading, userLoading, personDetailsLoading, _caprSearchLoading)',
            observer: '_loadingChanged'
          },
          
          /**
           * Whether the user is being loaded.
           */
          userLoading: {
            type: Boolean,
            value: false
          },
          
          /**
           * Bound to the loading attribute of the person-details component. Therefore
           * it will reflect the person-details loading state.
           */
          personDetailsLoading: {
            type: Boolean,
            value: false
          },
          
          /** 
           * Whether the parents relationship lookup is still loading 
           * (for adding persons via the pedigree)
           */
          _caprSearchLoading: {
            type: Boolean,
            value: false
          },
          
          /**
           * Supported values are 'person' and 'pedigree'
           */
          page: {
            type: String,
            value: 'person'
          },
          
          authenticated: {
            type: Boolean,
            value: false,
            notify: true
          }
        };
      }
      
      /**
       * This method is called when the component and it's children have been
       * setup. This method is guaranteed to only be called once.
       * https://www.polymer-project.org/2.0/docs/devguide/registering-elements#lifecycle-callbacks
       */
      ready() {
        super.ready();
        this._routerSetup();
        
        // Handle signin/signout events.
        // We manually set this up here instead of in the markup because
        // the authenticated-changed event gets fired on load with the default
        // value of false which then triggers our sign-out reload behavior.
        // Manually attaching the listener here causes it to miss the initial
        // change event with the default value of false.
        // An alternative would be to change our sign-out behavior.
        this.$.client.addEventListener('authenticated-changed', (e) => this._authenticatedChanged(e));
        
        // Hide the person card if anything else is clicked.
        // I'm pretty sure we can't do this via markup (i.e. can't register
        // an event listener on the custom element itself).
        this.addEventListener('click', this._hidePersonCard.bind(this));
      }
      
      /**
       * Show the person card.
       */
      _showPersonCard(event) {
        if(event.detail.personId){
          this.$.personCard.personId = event.detail.personId;
          this.$.personCard.style.display = 'block';
          this.$.personCard.style.left = event.detail.sourceEvent.pageX + 'px';
          this.$.personCard.style.top = event.detail.sourceEvent.pageY + 'px';
        }
      }
      
      /**
       * Hide the person card if something besides a fs-person-chip is clicked
       */
      _hidePersonCard(e) {
        const path = e.path || this._nodePath(e.target);
        const pathLength = path.length;
        for(let i = 0; i < pathLength; i++){
          if(path[i] instanceof FSPersonChip) {
            return;
          }
        }
        this.$.personCard.style.display = 'none';
      }
      
      /**
       * Calculate an element's node path (list of parent nodes)
       */
      _nodePath(e) {
        const path = [];
        const c = e;
        while(c) {
          path.push(c);
          c = c.parentNode;
        }
        return path;
      }
      
      /**
       * Show a person's profile when the person card profile button is clicked.
       */
      _navigateToProfile() {
        page('/person/' + this.$.personCard.personId);
      }
      
      /**
       * Show a person's pedigree when the person card pedigree button is clicked.
       */
      _navigateToPedigree() {
        page('/pedigree/' + this.$.personCard.personId);
      }
      
      /**
       * Used to calculate when the loading indicator should load.
       */
      _isLoading(personLoading, userLoading, personDetailsLoading, _caprSearchLoading) {
        return personLoading || userLoading || personDetailsLoading || _caprSearchLoading;
      }
      
      /**
       * Freeze window scroll when loading
       */
      _loadingChanged(loading) {
        if(loading){
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = 'auto';
        }
      }
      
      /**
       * Reload the pedigree and person details
       */
      _reload() {
        this.$.pedigree.reload();
        this.$.personDetails._reloadFamilies();
      }
      
      /**
       * Add the personId to the history list when it's available.
       */
      _personIdChanged(personId) {
        if(personId){
          this.$.history.addPerson(personId);
        }
      }
      
      /** 
       * Handle sign in and sign out actions. We can't use the fs-client redirect
       * properties because our router won't notice them and respond appropriately
       * so we must manually handle them and tell our router where to go.
       */
      _authenticatedChanged(event) {
          
        // Sign in
        if(event.detail.value) {
          page('/person');
        } 
        
        // Sign out
        else {
          this.personId = '';
          this.user = {};
          this.$.history.clear();
          page('/');
        }
      }
      
      /**
       * Decided whether the person-details section should be displayed.
       */
      _showPersonDetails(authenticated, page) {
        return authenticated && page === 'person';
      }
      
      /**
       * Decided whether the pedigree section should be displayed.
       */
      _showPedigree(authenticated, page) {
        return authenticated && page === 'pedigree';
      }
      
      /**
       * Toggle between the person and pedigree pages.
       */
      _togglePage() {
        if(this.page === 'person'){
          page('/pedigree/' + this.personId);
        } else {
          page('/person/' + this.personId);
        }
      }
      
      /**
       * Process the person-select event from the person-history element
       */
      _historySelect(e){
        if(e.detail.personId){
          page('/' + this.page + '/' + e.detail.personId);
        }
      }
      
      _navButtonText(page) {
        if(this.page === 'person'){
          return 'Pedigree';
        } else {
          return 'Person';
        }
      }
      
      /**
       * Trigger the Add Person dialog
       */
      _addPedigreePerson(e) {
        
        const {childId, fatherId, motherId} = e.detail;
        
        // We can't do anything without a childId
        if(childId) {
          
          // We need to query for an existing child-and-parents relationship
          if(fatherId || motherId) {
            this._caprSearchLoading = true;
            const request = new FSRequest();
            request.url = `/platform/tree/persons/${childId}/parents`;
            request.ready();
            request.addEventListener('response', (e) => {
              const response = e.detail.response;
              const caprIds = [];
              if(response.data && response.data.childAndParentsRelationships) {
                response.data.childAndParentsRelationships.forEach((rel) => {
                  if(this._caprMatches(rel, childId, fatherId, motherId)) {
                    caprIds.push(rel.id);
                  }
                });
              }
              this.$.addPerson.motherId = motherId;
              this.$.addPerson.fatherId = fatherId;
              this.$.addPerson.caprIds = caprIds;
              this._caprSearchLoading = false;
              this.$.addPerson.open();
            });
            request.generateRequest();
          } 
          
          // Don't need to look for a capr; just open the dialog
          else {
            this.$.addPerson.childId = childId;
            this.$.addPerson.open();
          }
        }
      }
      
      /**
       * Check whether a child-and-parents relationship matches the given
       * childId, fatherId, and motherId
       * 
       * @return {Boolean}
       */
      _caprMatches(rel, childId, fatherId, motherId) {
        return rel.child.resourceId === childId 
           && // Father matches in both or doesn't exist in both
          (
            // Father exists and matches in both
            (fatherId && rel.father && rel.father.resourceId === fatherId)
            
            // Or father doesn't exist in both
            || (!fatherId && !rel.father)
          )
          
          && // Mother matches in both or doesn't exist in both
          (
            // Mother exists and matches in both
            (motherId && rel.mother && rel.mother.resourceId === motherId)
            
            // Or mother doesn't exist in both
            || (!motherId && !rel.mother)
          );
      }
      
      /**
       * Configure the router. We use page.js instead of Polymer app-routes because
       * we need asynchronous middleware to make sure the user is logged in.
       */
      _routerSetup() {
        var app = this;
        
        page('/person', ensureAuth, loadUser, function(){
          page.redirect('/person/' + app.user.personId);
        });
        page('/person/:personId', ensureAuth, function(context){
          app.personId = context.params.personId;
          app.page = 'person';
        });
        page('/pedigree/:personId', ensureAuth, function(context){
          app.personId = context.params.personId;
          app.page = 'pedigree';
        });
        
        // When signed in, forward to /person by default to load the current user
        // so that we then know who the start person is.
        // When signed out, show a welcome message.
        page('/', function(){
          if(app.authenticated){
            page.redirect('/person');
          }
        });
        
        // Setup event bindings and start the router.
        page();
        
        /**
         * Make sure the user is logged in before proceeding with the route.
         * Forward the user to the home page if they're not logged in.
         */
        function ensureAuth(context, next){
          if(!app.authenticated){
            page('/');
          } else {
            next();
          }
        }
        
        /**
         * Load the current user if it isn't already available. The current user
         * is required for knowing who the start person is.
         */
        function loadUser(context, next){
          if(!app.user){
            app.userLoading = true;
            app.$.client.client.get('/platform/users/current', function(error, response){
              app.userLoading = false;
              if(error){
                console.error(error);
              } else if(response && response.statusCode === 200){
                app.user = response.data.users[0];
              } else if(response && response.statusCode === 401){
                app.$.client.signOut();
                page('/');
                return;
              }
              next();
            });
          } else {
            next();
          }
        }
      }
    }
    
    customElements.define(SampleApp.is, SampleApp);
  </script>
</dom-module>
